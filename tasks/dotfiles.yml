---
- name: Manage dotfiles
  block:
    - name: Set backup timestamp
      ansible.builtin.set_fact:
        backup_timestamp: "{{ ansible_date_time.iso8601_basic_short }}"

    - name: Create dotfiles backup directory
      ansible.builtin.file:
        path: '{{ ansible_env.HOME }}/.dotfiles-backup-{{ backup_timestamp }}'
        state: directory
        mode: '0755'

    - name: Backup existing dotfiles
      ansible.builtin.copy:
        src: '{{ ansible_env.HOME }}/{{ item }}'
        dest: '{{ ansible_env.HOME }}/.dotfiles-backup-{{ backup_timestamp }}/{{ item }}'
        remote_src: yes
      loop:
        - .gitignore_global
        - .vimrc
        - .tmux.conf
        - .editorconfig
        - .inputrc
        - .curlrc
        - .wgetrc
        - .terraformrc
        - .zshrc
        - .gitconfig
      ignore_errors: yes
      register: backup_result

    - name: Display backup location
      ansible.builtin.debug:
        msg: "Existing dotfiles backed up to: ~/.dotfiles-backup-{{ backup_timestamp }}"
      when: backup_result is changed

    - name: Create .config directory
      ansible.builtin.file:
        path: '{{ ansible_env.HOME }}/.config'
        state: directory
        mode: '0755'

    # ============================================
    # Git Configuration
    # ============================================
    - name: Symlink global gitignore
      ansible.builtin.file:
        src: '{{ playbook_dir }}/dotfiles/.gitignore_global'
        dest: '{{ ansible_env.HOME }}/.gitignore_global'
        state: link

    - name: Configure git to use global gitignore
      community.general.git_config:
        name: 'core.excludesfile'
        value: '~/.gitignore_global'
        scope: global

    - name: Include git global configuration
      ansible.builtin.blockinfile:
        path: '{{ ansible_env.HOME }}/.gitconfig'
        create: yes
        mode: '0644'
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Global Git Config"
        block: |
          [include]
            path = {{ playbook_dir }}/dotfiles/.gitconfig_global

    # ============================================
    # Editor Configurations
    # ============================================
    - name: Source vim configuration from repo
      ansible.builtin.blockinfile:
        path: '{{ ansible_env.HOME }}/.vimrc'
        create: yes
        mode: '0644'
        marker: '" {mark} ANSIBLE MANAGED BLOCK - Vim Config'
        block: |
          " Source vim configuration from repo
          if filereadable("{{ playbook_dir }}/dotfiles/.vimrc")
            source {{ playbook_dir }}/dotfiles/.vimrc
          endif

    - name: Source tmux configuration from repo
      ansible.builtin.blockinfile:
        path: '{{ ansible_env.HOME }}/.tmux.conf'
        create: yes
        mode: '0644'
        marker: '# {mark} ANSIBLE MANAGED BLOCK - Tmux Config'
        block: |
          # Source tmux configuration from repo
          source-file {{ playbook_dir }}/dotfiles/.tmux.conf

    - name: Symlink editorconfig
      ansible.builtin.file:
        src: '{{ playbook_dir }}/dotfiles/.editorconfig'
        dest: '{{ ansible_env.HOME }}/.editorconfig'
        state: link

    # ============================================
    # Shell Configurations
    # ============================================
    - name: Symlink inputrc (readline configuration)
      ansible.builtin.file:
        src: '{{ playbook_dir }}/dotfiles/.inputrc'
        dest: '{{ ansible_env.HOME }}/.inputrc'
        state: link

    - name: Source aliases and local config in .zshrc
      ansible.builtin.blockinfile:
        path: '{{ ansible_env.HOME }}/.zshrc'
        create: yes
        mode: '0644'
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Aliases and Functions"
        block: |
          # Load custom aliases
          if [ -f {{ playbook_dir }}/dotfiles/.aliases ]; then
            source {{ playbook_dir }}/dotfiles/.aliases
          fi

          # Load custom functions
          if [ -f {{ playbook_dir }}/dotfiles/.functions ]; then
            source {{ playbook_dir }}/dotfiles/.functions
          fi

          # Load local user-specific configuration
          if [ -f {{ playbook_dir }}/dotfiles/.zshrc.local ]; then
            source {{ playbook_dir }}/dotfiles/.zshrc.local
          fi

    # ============================================
    # Tool Configurations
    # ============================================
    - name: Symlink curlrc
      ansible.builtin.file:
        src: '{{ playbook_dir }}/dotfiles/.curlrc'
        dest: '{{ ansible_env.HOME }}/.curlrc'
        state: link

    - name: Symlink wgetrc
      ansible.builtin.file:
        src: '{{ playbook_dir }}/dotfiles/.wgetrc'
        dest: '{{ ansible_env.HOME }}/.wgetrc'
        state: link

    - name: Symlink terraformrc
      ansible.builtin.file:
        src: '{{ playbook_dir }}/dotfiles/.terraformrc'
        dest: '{{ ansible_env.HOME }}/.terraformrc'
        state: link

    - name: Create Terraform plugin cache directory
      ansible.builtin.file:
        path: '{{ ansible_env.HOME }}/.terraform.d/plugin-cache'
        state: directory
        mode: '0755'
