---
- name: Install goto shell function
  block:
    - name: Prompt for Git platform choice
      ansible.builtin.pause:
        prompt: 'Choose default Git platform for goto function (gitlab/github) [gitlab]'
      register: goto_platform_prompt

    - name: Prompt for default organization/username
      ansible.builtin.pause:
        prompt: 'Enter your default organization/username for goto function [vercara]'
      register: goto_user_prompt

    - name: Prompt for goto root directory
      ansible.builtin.pause:
        prompt: 'Enter the root directory for repositories (press Enter for default: ~/dev/src)'
      register: goto_root_prompt

    - name: Set goto default values
      ansible.builtin.set_fact:
        goto_platform: "{{ goto_platform_prompt.user_input | default('gitlab', true) | lower }}"
        goto_default_user: "{{ goto_user_prompt.user_input | default('vercara', true) }}"
        goto_root: "{{ goto_root_prompt.user_input | default('~/dev/src', true) }}"

    - name: Set platform-specific values
      ansible.builtin.set_fact:
        goto_domain: "{{ 'gitlab.com' if goto_platform == 'gitlab' else 'github.com' }}"

    - name: Create goto root directory
      ansible.builtin.file:
        path: "{{ goto_root | regex_replace('^~', ansible_env.HOME) }}/{{ goto_domain }}"
        state: directory
        mode: '0755'

    - name: Install goto function in .zshrc
      ansible.builtin.blockinfile:
        path: '{{ ansible_env.HOME }}/.zshrc'
        create: yes
        mode: '0644'
        marker: "# {mark} ANSIBLE MANAGED BLOCK - goto function"
        block: |
          # goto - Quick navigation to Git repositories
          export GOTO_ROOT="{{ goto_root }}"
          export GOTO_DEFAULT_USER="{{ goto_default_user }}"
          export GOTO_PLATFORM="{{ goto_platform }}"
          export GOTO_DOMAIN="{{ goto_domain }}"

          goto() {
            local input=$1
            local user
            local repo
            local target_dir
            local git_url

            if [[ -z "$input" ]]; then
              echo "Usage: goto <project> OR goto <user>/<project>"
              echo "Current platform: $GOTO_PLATFORM ($GOTO_DOMAIN)"
              echo "Default user/org: $GOTO_DEFAULT_USER"
              return 1
            fi

            if [[ "$input" == *"/"* ]]; then
              user=${input%%/*}
              repo=${input#*/}
            else
              user=$GOTO_DEFAULT_USER
              repo=$input
            fi

            target_dir="$GOTO_ROOT/$GOTO_DOMAIN/$user/$repo"

            if [[ -d "$target_dir" ]]; then
              echo "ðŸš€ Jumping to existing directory: $target_dir"
              cd "$target_dir"
              return 0
            fi

            echo "ðŸ“‚ Directory not found. Preparing to clone..."
            mkdir -p "$(dirname "$target_dir")"

            git_url="git@$GOTO_DOMAIN:$user/$repo.git"
            echo "â¬‡ï¸  Cloning $git_url..."

            if git clone "$git_url" "$target_dir"; then
              echo "âœ… Clone successful! Entering directory..."
              cd "$target_dir"
            else
              echo "âŒ Clone failed. Please check the repository name and your permissions."
              rmdir "$target_dir" 2>/dev/null
              return 1
            fi
          }

    - name: Display goto installation message
      ansible.builtin.debug:
        msg:
          - "goto function installed successfully!"
          - "Platform: {{ goto_platform }} ({{ goto_domain }})"
          - "Default organization/user: {{ goto_default_user }}"
          - "Root directory: {{ goto_root }}"
          - ""
          - "Usage examples:"
          - "  goto my-repo              # Clones/navigates to {{ goto_default_user }}/my-repo"
          - "  goto other-org/project    # Clones/navigates to other-org/project"
          - ""
          - "Directory structure: {{ goto_root }}/{{ goto_domain }}/<user>/<repo>"
          - ""
          - "Restart your shell or run: source ~/.zshrc"
