# Shell Functions for Development

# ============================================
# Navigation Helpers
# ============================================

# Create a directory and cd into it
mkcd() {
  mkdir -p "$1" && cd "$1"
}

# Go up n directories
up() {
  local d=""
  limit=$1
  for ((i=1 ; i <= limit ; i++)); do
    d=$d/..
  done
  d=$(echo $d | sed 's/^\///')
  if [ -z "$d" ]; then
    d=..
  fi
  cd $d
}

# ============================================
# File Operations
# ============================================

# Extract any archive
extract() {
  if [ -f "$1" ]; then
    case "$1" in
      *.tar.bz2)   tar xjf "$1"     ;;
      *.tar.gz)    tar xzf "$1"     ;;
      *.bz2)       bunzip2 "$1"     ;;
      *.rar)       unrar x "$1"     ;;
      *.gz)        gunzip "$1"      ;;
      *.tar)       tar xf "$1"      ;;
      *.tbz2)      tar xjf "$1"     ;;
      *.tgz)       tar xzf "$1"     ;;
      *.zip)       unzip "$1"       ;;
      *.Z)         uncompress "$1"  ;;
      *.7z)        7z x "$1"        ;;
      *)           echo "'$1' cannot be extracted via extract()" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# Create a backup of a file
backup() {
  cp "$1" "${1}.backup-$(date +%Y%m%d-%H%M%S)"
}

# ============================================
# Git Helpers
# ============================================

# Git clone and cd into directory
gcl() {
  git clone "$1" && cd "$(basename "$1" .git)"
}

# Initialize git repo and make first commit
ginit() {
  git init
  git add .
  git commit -m "Initial commit"
}

# Git commit with auto-generated message from diff
gquick() {
  git add .
  git commit -m "Quick commit: $(git diff --cached --stat | tail -1)"
}

# Show git branches sorted by last commit date
gbrecent() {
  git for-each-ref --sort=-committerdate refs/heads/ --format='%(HEAD) %(color:yellow)%(refname:short)%(color:reset) - %(color:red)%(objectname:short)%(color:reset) - %(contents:subject) - %(authorname) (%(color:green)%(committerdate:relative)%(color:reset))'
}

# Delete merged branches
gcleanup() {
  git branch --merged | grep -v "\*" | grep -v "main" | grep -v "master" | xargs -n 1 git branch -d
}

# ============================================
# Docker Helpers
# ============================================

# Docker remove all stopped containers
drmall() {
  docker rm $(docker ps -aq)
}

# Docker remove all images
drmiall() {
  docker rmi $(docker images -q)
}

# Docker bash into running container
dbash() {
  docker exec -it "$1" /bin/bash
}

# Docker sh into running container
dsh() {
  docker exec -it "$1" /bin/sh
}

# ============================================
# Network Helpers
# ============================================

# Check if a port is open
portcheck() {
  nc -zv localhost "$1"
}

# Kill process running on specific port
killport() {
  lsof -ti:"$1" | xargs kill -9
}

# Show what's listening on a port
listening() {
  if [ $# -eq 0 ]; then
    sudo lsof -iTCP -sTCP:LISTEN -n -P
  elif [ $# -eq 1 ]; then
    sudo lsof -iTCP -sTCP:LISTEN -n -P | grep -i --color "$1"
  else
    echo "Usage: listening [pattern]"
  fi
}

# ============================================
# Development Helpers
# ============================================

# Find and replace in files
findreplace() {
  if [ $# -ne 2 ]; then
    echo "Usage: findreplace <search> <replace>"
    return 1
  fi
  grep -rl "$1" . | xargs sed -i '' "s/$1/$2/g"
}

# Count lines of code
loc() {
  find . -name "*.$1" | xargs wc -l | sort -n
}

# Generate a random string
genpass() {
  openssl rand -base64 ${1:-32}
}

# ============================================
# JSON Helpers
# ============================================

# Pretty print JSON
json() {
  if [ -t 0 ]; then
    # Argument passed
    python3 -m json.tool <<< "$*" | less
  else
    # Pipe
    python3 -m json.tool | less
  fi
}

# ============================================
# Kubernetes Helpers
# ============================================

# Get pod logs with fuzzy search
klog() {
  local pod=$(kubectl get pods | fzf | awk '{print $1}')
  kubectl logs -f "$pod"
}

# Exec into pod with fuzzy search
kexec() {
  local pod=$(kubectl get pods | fzf | awk '{print $1}')
  kubectl exec -it "$pod" -- /bin/sh
}

# ============================================
# NPM Helpers
# ============================================

# NPM install and save
nis() {
  npm install --save "$@"
}

# NPM global list
ngl() {
  npm list -g --depth=0
}

# ============================================
# Python Helpers
# ============================================

# Create and activate virtual environment
mkvenv() {
  python3 -m venv ${1:-.venv}
  source ${1:-.venv}/bin/activate
  pip install --upgrade pip
}

# ============================================
# File Search
# ============================================

# Find file by name
fname() {
  find . -iname "*$1*"
}

# Find file by content
fcontent() {
  grep -rnw . -e "$1"
}

# ============================================
# Performance
# ============================================

# Measure command execution time
timeit() {
  time "$@"
}

# Show disk usage of directories
duh() {
  du -h --max-depth=1 | sort -h
}

# ============================================
# Misc Utilities
# ============================================

# Create a data URL from a file
dataurl() {
  local mimeType=$(file -b --mime-type "$1")
  if [[ $mimeType == text/* ]]; then
    mimeType="${mimeType};charset=utf-8"
  fi
  echo "data:${mimeType};base64,$(openssl base64 -in "$1" | tr -d '\n')"
}

# Start a simple HTTP server from current directory
server() {
  local port="${1:-8000}"
  python3 -m http.server "$port"
}

# Get weather
weather() {
  curl "wttr.in/${1:-}"
}

# Cheat sheet lookup
cheat() {
  curl "cheat.sh/$1"
}
