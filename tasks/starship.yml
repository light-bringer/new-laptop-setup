---
- name: Install and configure Starship prompt
  block:
    - name: Install Starship via Homebrew
      community.general.homebrew:
        name: starship
        state: present

    - name: Create Starship config directory
      ansible.builtin.file:
        path: '{{ ansible_env.HOME }}/.config'
        state: directory
        mode: '0755'

    - name: Configure Starship in .zshrc
      ansible.builtin.blockinfile:
        path: '{{ ansible_env.HOME }}/.zshrc'
        create: yes
        mode: '0644'
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Starship"
        block: |
          # Starship prompt - https://starship.rs
          eval "$(starship init zsh)"

    - name: Create default Starship configuration
      ansible.builtin.copy:
        dest: '{{ ansible_env.HOME }}/.config/starship.toml'
        mode: '0644'
        content: |
          # Starship Configuration
          # Get editor completions based on the config schema
          "$schema" = 'https://starship.rs/config-schema.json'

          # Inserts a blank line between shell prompts
          add_newline = true

          # Timeout for commands executed by starship (ms)
          command_timeout = 500

          # Format configuration
          format = """
          [â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>](bold green)
          [â”‚](bold green)$os\
          $username\
          $hostname\
          $directory\
          $git_branch\
          $git_status\
          $golang\
          $nodejs\
          $python\
          $rust\
          $docker_context
          [â””â”€>](bold green) """

          # OS symbol
          [os]
          disabled = false
          style = "bold blue"

          [os.symbols]
          Macos = " "

          # Username
          [username]
          show_always = false
          style_user = "bold yellow"
          style_root = "bold red"
          format = "[$user]($style) "

          # Directory
          [directory]
          truncation_length = 3
          truncate_to_repo = true
          style = "bold cyan"
          read_only = " "
          read_only_style = "red"

          # Git branch
          [git_branch]
          symbol = " "
          style = "bold purple"
          truncation_length = 20

          # Git status
          [git_status]
          style = "bold red"
          conflicted = "ğŸ³"
          ahead = "â‡¡${count}"
          behind = "â‡£${count}"
          diverged = "â‡•â‡¡${ahead_count}â‡£${behind_count}"
          up_to_date = "âœ“"
          untracked = "ğŸ¤·"
          stashed = "ğŸ“¦"
          modified = "ğŸ“"
          staged = '[++\($count\)](green)'
          renamed = "ğŸ‘…"
          deleted = "ğŸ—‘"

          # Programming Languages
          [golang]
          symbol = " "
          style = "bold cyan"
          format = "via [$symbol($version )]($style)"

          [nodejs]
          symbol = " "
          style = "bold green"
          format = "via [$symbol($version )]($style)"

          [python]
          symbol = " "
          style = "bold yellow"
          format = 'via [${symbol}${pyenv_prefix}(${version} )(\($virtualenv\) )]($style)'

          [rust]
          symbol = " "
          style = "bold red"
          format = "via [$symbol($version )]($style)"

          # Docker
          [docker_context]
          symbol = " "
          style = "bold blue"
          format = "via [$symbol$context]($style) "
          only_with_files = true

          # Command duration
          [cmd_duration]
          min_time = 500
          format = "took [$duration](bold yellow) "

          # Character
          [character]
          success_symbol = "[âœ](bold green)"
          error_symbol = "[âœ](bold red)"

          # Disable modules
          [package]
          disabled = true
        force: no

    - name: Verify Starship installation
      ansible.builtin.command: starship --version
      register: starship_version
      changed_when: false

    - name: Display Starship installation message
      ansible.builtin.debug:
        msg:
          - "Starship prompt installed successfully!"
          - "Version: {{ starship_version.stdout }}"
          - ""
          - "Configuration file: ~/.config/starship.toml"
          - "Customize your prompt at: https://starship.rs/config/"
          - ""
          - "Restart your shell or run: exec zsh"
